import{d as j,au as ne,u as W,r as n,J as Z,h as f,i as S,w as d,l as e,L as R,M as N,m as w,t as c,n as C,j as y,k as v,Q as le,s as se,ar as oe,q as I,a1 as re,_ as M,ai as ee,av as ue,e as E,V as z,aw as de,as as ce,at as pe,z as B,ad as ve,P as ae,Y,ac as fe,a as me,c as _e,o as ye,W as ge,F as O,ax as be,y as ke}from"./index-BlEQ5104.js";import{_ as he}from"./FormLayout.vue_vue_type_script_setup_true_lang-DaMAl8E3.js";import{j as De}from"./vue-datepicker-Cy0B1WeD.js";import{u as we}from"./fileUpload-2kJDzwnA.js";import{u as te}from"./useTimer-hCPxFuk6.js";import"./index-D2UKjnCl.js";const xe={class:"flex flex-col gap-y-6"},Te={key:0},Se={class:"flex flex-col"},Ve={key:0,class:ue("mt-2 text-sm text-rose-700 dark:text-rose-400")},Ue={class:"flex justify-end"},Ce=j({__name:"ScheduleUpdateDrawer",props:{isShown:{type:Boolean},updateVersion:{},scheduleToEdit:{}},emits:["close","schedule-saved","system-update-requested"],setup(q,{emit:a}){const l=q,t=ne(),s=a,{t:i}=W(),p=n(""),x=n(!1),r=n(""),g=n("now"),_=n(new Date),$=n(!1),u=n({notificationTitle:"",notificationDescription:"",notificationDetails:""}),V=[{id:"now",label:i("standalone.update.now")},{id:"date_time",label:i("standalone.update.schedule_time_and_date")}],U=k=>k<new Date;function h(){r.value=l.updateVersion,l.scheduleToEdit?(x.value=!0,g.value="date_time",_.value=l.scheduleToEdit):(g.value="now",_.value=new Date)}function o(){u.value={notificationTitle:"",notificationDescription:"",notificationDetails:""},p.value="",s("close")}function P(){const k=de(_.value);return k.valid?!0:(p.value=i(k.errMessage),!1)}async function L(){if(p.value="",$.value=!0,g.value=="date_time"){if(!P())return;try{await E("ns.update","schedule-system-update",{scheduleAt:_.value.getTime()/1e3}),s("schedule-saved"),o()}catch(k){u.value.notificationTitle=i("error.cannot_set_update_schedule"),u.value.notificationDescription=i(z(k)),u.value.notificationDetails=k.toString()}}else try{await E("ns.update","update-system"),s("system-update-requested"),o()}catch(k){!k.response||!k.response.data?(s("system-update-requested"),o()):(u.value.notificationTitle=i("error.cannot_update_system"),u.value.notificationDescription=i(z(k)),u.value.notificationDetails=k.toString())}$.value=!1}return Z(()=>l.isShown,()=>{l.isShown&&h()}),(k,b)=>(f(),S(e(ee),{"is-shown":k.isShown,onClose:b[5]||(b[5]=D=>o()),closeAriaLabel:e(i)("common.shell.close_side_drawer"),title:x.value?e(i)("standalone.update.edit_scheduled_date"):e(i)("standalone.update.update_system")},{default:d(()=>[u.value.notificationTitle?(f(),S(e(R),{key:0,title:u.value.notificationTitle,description:u.value.notificationDescription,class:"mb-6",kind:"error"},N({_:2},[u.value.notificationDetails?{name:"details",fn:d(()=>[w(c(u.value.notificationDetails),1)]),key:"0"}:void 0]),1032,["title","description"])):C("",!0),y("div",xe,[v(e(le),{modelValue:r.value,"onUpdate:modelValue":b[0]||(b[0]=D=>r.value=D),label:e(i)("standalone.update.update_to_version"),disabled:!0},null,8,["modelValue","label"]),v(e(oe),{options:V,label:e(i)("standalone.update.choose_when_to_update"),modelValue:g.value,"onUpdate:modelValue":b[1]||(b[1]=D=>g.value=D)},{tooltip:d(()=>[v(e(se),null,{content:d(()=>[w(c(e(i)("standalone.update.schedule_mode_tooltip")),1)]),_:1})]),_:1},8,["label","modelValue"]),g.value==="date_time"?(f(),I("div",Te,[v(e(re),{class:"mb-2"},{default:d(()=>[w(c(e(i)("standalone.update.time_and_date")),1)]),_:1}),y("div",Se,[v(e(De),{modelValue:_.value,"onUpdate:modelValue":b[2]||(b[2]=D=>_.value=D),"time-picker-inline":!0,clearable:!1,"disabled-dates":U,dark:!e(t).isLight,format:D=>(D==null?void 0:D.toLocaleString([],{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}))??""},null,8,["modelValue","dark","format"]),p.value?(f(),I("p",Ve,c(p.value),1)):C("",!0)])])):C("",!0),b[6]||(b[6]=y("hr",null,null,-1)),y("div",Ue,[v(e(M),{kind:"tertiary",class:"mr-4",onClick:b[3]||(b[3]=D=>o())},{default:d(()=>[w(c(e(i)("common.cancel")),1)]),_:1}),v(e(M),{kind:"primary",onClick:b[4]||(b[4]=D=>L()),disabled:$.value,loading:$.value},{default:d(()=>[w(c(g.value==="now"?e(i)("standalone.update.update_and_reboot"):x.value?e(i)("common.save"):e(i)("standalone.update.schedule")),1)]),_:1},8,["disabled","loading"])])])]),_:1},8,["is-shown","closeAriaLabel","title"]))}}),$e={class:"flex flex-col gap-y-6"},Pe={class:"flex justify-end"},Ae=j({__name:"UploadImageDrawer",props:{isShown:{type:Boolean}},emits:["close","update-requested"],setup(q,{emit:a}){const{t:l}=W(),t=n({notificationTitle:"",notificationDescription:"",notificationDetails:""}),s=n(""),i=n(!1),p=n(!1),x=n(!1),r=n(0),g=n(""),_=n(null);async function $(){if(s.value="",i.value=!1,x.value=!1,!_.value)return;const h=pe(_.value,"img.gz");if(!h.valid){s.value=l(h.errMessage);return}try{r.value=.1,x.value=!0;const o=await we(_.value,P=>{r.value=P.progress*100});g.value=o.data.data,i.value=!0}catch(o){t.value.notificationTitle=l("error.cannot_upload_image"),t.value.notificationDescription=l(z(o)),t.value.notificationDetails=o.toString()}finally{x.value=!1}}const u=a;function V(){t.value.notificationTitle="",t.value.notificationDescription="",t.value.notificationDetails="",s.value="",_.value=null,i.value=!1,x.value=!1,g.value="",u("close")}async function U(){try{p.value=!0,await E("ns.update","install-uploaded-image",{image:g.value}),u("update-requested"),V()}catch(h){!h.response||!h.response.data?(u("update-requested"),V()):(t.value.notificationTitle=l("error.cannot_update_system"),t.value.notificationDescription=l(z(h)),t.value.notificationDetails=h.toString())}finally{p.value=!1}}return(h,o)=>(f(),S(e(ee),{"is-shown":h.isShown,onClose:o[3]||(o[3]=P=>p.value?void 0:V()),closeAriaLabel:e(l)("common.shell.close_side_drawer"),title:e(l)("standalone.update.update_with_image_file")},{default:d(()=>[y("div",$e,[t.value.notificationTitle?(f(),S(e(R),{key:0,kind:"error",title:t.value.notificationTitle,description:t.value.notificationDescription},N({_:2},[t.value.notificationDetails?{name:"details",fn:d(()=>[w(c(t.value.notificationDetails),1)]),key:"0"}:void 0]),1032,["title","description"])):C("",!0),y("div",null,[v(e(ce),{label:`${e(l)("standalone.update.image_file")} (*.img.gz)`,onSelect:$,"invalid-message":s.value,"show-progress":x.value,progress:r.value,dropzoneLabel:e(l)("ne_file_input.dropzone_label"),modelValue:_.value,"onUpdate:modelValue":o[0]||(o[0]=P=>_.value=P)},null,8,["label","invalid-message","show-progress","progress","dropzoneLabel","modelValue"])]),o[4]||(o[4]=y("hr",null,null,-1)),y("div",Pe,[v(e(M),{kind:"tertiary",class:"mr-4",onClick:o[1]||(o[1]=P=>p.value?void 0:V())},{default:d(()=>[w(c(e(l)("common.cancel")),1)]),_:1}),v(e(M),{kind:"primary",onClick:o[2]||(o[2]=P=>U()),disabled:p.value||!i.value,loading:p.value},{default:d(()=>[w(c(e(l)("standalone.update.update_and_reboot")),1)]),_:1},8,["disabled","loading"])])])]),_:1},8,["is-shown","closeAriaLabel","title"]))}}),Ee={class:"max-h-96 overflow-y-auto"},Ie={class:"text-gray-500 dark:text-gray-400"},Fe=2e4,Re=j({__name:"UpdatePackagesModal",props:{packageUpdates:{}},emits:["close","packages-updated"],setup(q,{emit:a}){const l=n({notificationDescription:"",notificationDetails:""}),t=a,{t:s}=W(),i=n(!1),p=n(!1),{startTimer:x,currentProgress:r,clearTimer:g}=te({duration:Fe,progressStep:.5,onTimerFinish:()=>{t("packages-updated"),g(),_()}});function _(){p.value=!1,l.value.notificationDescription="",l.value.notificationDetails="",t("close")}async function $(){try{i.value=!0,await E("ns.update","install-package-updates"),p.value=!0,x()}catch(u){l.value.notificationDescription=s(z(u)),l.value.notificationDetails=u.toString()}finally{i.value=!1}}return(u,V)=>(f(),S(e(Y),{visible:u.packageUpdates.length>0,kind:"info",title:e(s)("standalone.update.bug_security_fixes_to_update"),"primary-label":e(s)("standalone.update.update"),"primary-button-disabled":i.value||p.value,"primary-button-loading":i.value||p.value,"cancel-label":p.value?"":e(s)("common.cancel"),"close-aria-label":e(s)("common.close"),onClose:V[0]||(V[0]=U=>!p.value&&!i.value?_():void 0),onPrimaryClick:$},{default:d(()=>[y("div",Ee,[p.value?(f(),I(B,{key:1},[y("p",null,c(e(s)("standalone.update.update_in_progress_message")),1),v(e(ae),{class:"mt-4",progress:e(r)},null,8,["progress"])],64)):(f(),I(B,{key:0},[(f(!0),I(B,null,ve(u.packageUpdates,U=>(f(),I("p",{key:U.package},[w(c(U.package)+" ",1),y("span",Ie,c(e(s)("standalone.update.component_update_details",{versionFrom:U.currentVersion,versionTo:U.latestVersion})),1)]))),128)),l.value.notificationDescription?(f(),S(e(R),{key:0,title:e(s)("error.cannot_update_packages"),description:l.value.notificationDescription,class:"my-6",kind:"error"},N({_:2},[l.value.notificationDetails?{name:"details",fn:d(()=>[w(c(l.value.notificationDetails),1)]),key:"0"}:void 0]),1032,["title","description"])):C("",!0)],64))])]),_:1},8,["visible","title","primary-label","primary-button-disabled","primary-button-loading","cancel-label","close-aria-label"]))}}),qe=6e4,Le=j({__name:"SystemUpdateInProgressModal",props:{visible:{type:Boolean}},setup(q){const{t:a}=W(),l=q,{startTimer:t,currentProgress:s}=te({duration:qe,progressStep:.5,onTimerFinish:()=>{location.reload()}});return Z(()=>l.visible,()=>{l.visible&&t()}),(i,p)=>(f(),S(e(Y),{visible:i.visible,title:e(a)("standalone.update.system_update"),"primary-button-disabled":!0,"primary-button-loading":!0,"primary-label":e(a)("standalone.update.update"),kind:"info","cancel-label":"","close-aria-label":e(a)("common.close")},{default:d(()=>[y("p",null,c(e(a)("standalone.update.system_update_in_progress_message")),1),v(e(ae),{class:"mt-4",progress:e(s)},null,8,["progress"])]),_:1},8,["visible","title","primary-label","close-aria-label"]))}}),Me={class:"mb-4 text-sm font-normal text-gray-500 dark:text-gray-400"},ze={class:"flex flex-row items-start mb-4 gap-x-2"},Be={class:"text-sm font-normal text-gray-500 dark:text-gray-400"},Ne={class:"flex flex-row items-start mb-4 gap-x-2"},je={class:"text-sm font-normal text-gray-500 dark:text-gray-400"},We={key:0,class:"text-sm text-gray-500 dark:text-gray-400"},Oe={class:"mt-4"},Xe=j({__name:"UpdateView",setup(q){const{t:a}=W();fe(),me();const l=n(!0),t=n({notificationTitle:"",notificationDescription:"",notificationDetails:""}),s=n({notificationDescription:"",notificationDetails:""}),i=n(!1),p=n(null),x=n([]),r=n(null);n(!1);const g=n(!1),_=n(!1);n(!1);const $=n(!1),u=n(!1);n(!1);const V=n(!1),U=n(!1),h=n(!1),o=_e(()=>{var A;return(A=r.value)!=null&&A.scheduledAt&&r.value.scheduledAt!=-1?new Date(r.value.scheduledAt*1e3):null});function P(){t.value.notificationTitle="",t.value.notificationDescription="",t.value.notificationDetails=""}async function L(){var A,m;P(),l.value=!0,i.value=!1;try{const F=(await E("ns.update","get-package-updates-last-check")).data;F.lastCheck>0&&(p.value=new Date(F.lastCheck*1e3));const T=await E("ns.subscription","info");u.value=T.data.systemd_id!=""&&T.data.active,$.value=(await E("ns.update","get-automatic-updates-status")).data.enabled,r.value=(await E("ns.update","check-system-update")).data}catch(F){switch(i.value=!0,(m=(A=F.response)==null?void 0:A.data)==null?void 0:m.message){case"connection_error":t.value.notificationTitle=a("standalone.update.connection_error"),t.value.notificationDescription=a("standalone.update.connection_error_description");break;case"maintenance":t.value.notificationTitle=a("standalone.update.maintenance"),t.value.notificationDescription=a("standalone.update.maintenance_description");break;case"unauthorized":t.value.notificationTitle=a("standalone.update.unauthorized"),t.value.notificationDescription=a("standalone.update.unauthorized_description");break;case"server_error":t.value.notificationTitle=a("standalone.update.server_error"),t.value.notificationDescription=a("standalone.update.server_error_description");break;case"repository_url_not_set":t.value.notificationTitle=a("standalone.update.repository_url_not_set"),t.value.notificationDescription=a("standalone.update.repository_url_not_set_description");break;default:t.value.notificationTitle=a("standalone.update.generic_error"),t.value.notificationDescription=a("standalone.update.generic_error_description"),t.value.notificationDetails=F.toString()}}finally{l.value=!1}}async function k(){try{g.value=!0,await E("ns.update","schedule-system-update",{scheduleAt:-1}),b(),await L()}catch(A){s.value.notificationDescription=a(z(A)),s.value.notificationDetails=A.toString()}finally{g.value=!1}}function b(){s.value.notificationDescription="",s.value.notificationDetails="",h.value=!1}function D(){V.value=!0}return ye(()=>{L()}),(A,m)=>{var F;return f(),I(B,null,[v(e(ge),{tag:"h3",class:"mb-7"},{default:d(()=>[w(c(e(a)("standalone.update.title")),1)]),_:1}),t.value.notificationTitle?(f(),S(e(R),{key:0,title:t.value.notificationTitle,description:t.value.notificationDescription,class:"my-4",kind:"error"},N({_:2},[t.value.notificationDetails?{name:"details",fn:d(()=>[w(c(t.value.notificationDetails),1)]),key:"0"}:void 0]),1032,["title","description"])):C("",!0),m[8]||(m[8]=y("hr",{class:"my-6"},null,-1)),v(he,{class:"max-w-4xl",title:e(a)("standalone.update.system_update")},{description:d(()=>[y("p",Me,c(e(a)("standalone.update.system_update_description")),1),y("div",ze,[v(e(O),{icon:["fas","circle-info"],class:"w-4 h-4 text-indigo-500 dark:text-indigo-300"}),y("p",Be,c(e(a)("standalone.update.system_update_first_tip",{productName:e(be)()})),1)]),y("div",Ne,[v(e(O),{icon:["fas","circle-info"],class:"w-4 h-4 text-indigo-500 dark:text-indigo-300"}),y("p",je,c(e(a)("standalone.update.system_update_second_tip")),1)])]),default:d(()=>{var T,J,K,Q,G,H,X;return[l.value?(f(),S(e(ke),{key:0,lines:5})):(f(),I(B,{key:1},[(T=r.value)!=null&&T.currentVersion?(f(),I("p",We,c(e(a)("standalone.update.installed_release",{release:r.value.currentVersion})),1)):C("",!0),o.value?(f(),S(e(R),{key:1,kind:"info",class:"my-6",title:e(a)("standalone.update.system_update_scheduled"),description:e(a)("standalone.update.system_update_scheduled_description",{version:(J=r.value)==null?void 0:J.lastVersion,date:o.value.toLocaleString([],{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})}),"primary-button-label":e(a)("common.edit"),"secondary-button-label":e(a)("standalone.update.cancel_update"),onSecondaryClick:m[0]||(m[0]=ie=>h.value=!0),onPrimaryClick:D},null,8,["title","description","primary-button-label","secondary-button-label"])):(K=r.value)!=null&&K.lastVersion&&r.value.lastVersion!=((Q=r.value)==null?void 0:Q.currentVersion)?(f(),S(e(R),{key:2,kind:"info",class:"my-6",title:e(a)("standalone.update.new_release_available"),description:(G=r.value)==null?void 0:G.lastVersion},null,8,["title","description"])):C("",!0),y("div",Oe,[(H=r.value)!=null&&H.lastVersion&&r.value.lastVersion!=((X=r.value)==null?void 0:X.currentVersion)&&!o.value?(f(),S(e(M),{key:0,kind:"primary",class:"mb-2 mr-4",disabled:i.value,onClick:D},{prefix:d(()=>[v(e(O),{icon:["fas","arrows-rotate"],class:"w-4 h-4","aria-hidden":"true"})]),default:d(()=>[w(c(e(a)("standalone.update.update_system")),1)]),_:1},8,["disabled"])):C("",!0),o.value?C("",!0):(f(),S(e(M),{key:1,kind:"tertiary",onClick:m[1]||(m[1]=ie=>U.value=!0)},{prefix:d(()=>[v(e(O),{icon:["fas","circle-arrow-up"],class:"w-4 h-4","aria-hidden":"true"})]),default:d(()=>[w(c(e(a)("standalone.update.update_with_image_file")),1)]),_:1}))])],64))]}),_:1},8,["title"]),v(e(Y),{visible:h.value,kind:"info",title:e(a)("standalone.update.cancel_update"),"primary-label":e(a)("standalone.update.cancel_update"),"cancel-label":e(a)("standalone.update.keep_scheduled_update"),"primary-button-disabled":g.value,"primary-button-loading":g.value,"close-aria-label":e(a)("common.close"),onPrimaryClick:k,onClose:m[2]||(m[2]=T=>g.value?void 0:b())},{default:d(()=>{var T;return[y("p",null,c(e(a)("standalone.update.cancel_update_description",{version:(T=r.value)==null?void 0:T.lastVersion})),1),s.value.notificationDescription?(f(),S(e(R),{key:0,title:e(a)("error.cannot_cancel_schedule"),description:s.value.notificationDescription,kind:"error",class:"my-6"},N({_:2},[s.value.notificationDetails?{name:"details",fn:d(()=>[w(c(s.value.notificationDetails),1)]),key:"0"}:void 0]),1032,["title","description"])):C("",!0)]}),_:1},8,["visible","title","primary-label","cancel-label","primary-button-disabled","primary-button-loading","close-aria-label"]),v(Re,{"package-updates":x.value,onClose:m[3]||(m[3]=T=>x.value=[]),onPackagesUpdated:L},null,8,["package-updates"]),v(Ce,{"is-shown":V.value,onClose:m[4]||(m[4]=T=>V.value=!1),"update-version":((F=r.value)==null?void 0:F.lastVersion)??"","schedule-to-edit":o.value,onScheduleSaved:L,onSystemUpdateRequested:m[5]||(m[5]=T=>_.value=!0)},null,8,["is-shown","update-version","schedule-to-edit"]),v(Ae,{"is-shown":U.value,onClose:m[6]||(m[6]=T=>U.value=!1),onUpdateRequested:m[7]||(m[7]=T=>_.value=!0)},null,8,["is-shown"]),v(Le,{visible:_.value},null,8,["visible"])],64)}}});export{Xe as default};
