import{d as re,u as ce,E as ue,r as a,aa as de,o as ve,b as fe,g as K,h as l,q as _,j as m,k as i,w as r,m as d,t as c,l as e,W as _e,n as I,i as p,M as H,L as X,y as me,Q as U,s as L,$ as pe,z as x,a5 as ge,B as F,I as ye,v as be,_ as q,Y as Z,e as T,ag as ke,V as M,S as ee,aN as xe,T as Ve}from"./index-BlEQ5104.js";import{_ as De}from"./FormLayout.vue_vue_type_script_setup_true_lang-DaMAl8E3.js";const we={class:"flex flex-col justify-between md:flex-row md:items-center"},Ce={key:0,class:"mb-6 text-sm text-gray-500 dark:text-gray-400"},he={class:"flex flex-col gap-y-6"},Ie={key:1,class:"flex flex-col gap-y-6"},Se={class:"flex flex-col gap-2"},Re={class:"text-sm font-medium"},Ue={class:"flex flex-col gap-2"},Fe={class:"flex gap-2"},Te={class:"text-sm font-medium"},Me={class:"text-sm text-gray-400 dark:text-gray-500"},Be={key:5},Ne={key:6,class:"-mx-2 flex flex-row gap-x-4"},Ee=re({__name:"ControllerView",setup(je){const{t}=ce(),te=ue(),B=a(!1),v=a(!1),s=a({notificationTitle:"",notificationDescription:"",notificationDetails:""}),b=a({notificationDescription:"",notificationDetails:""}),f=a("unregistered"),N=a(),S=a(!1),V=a(!1),j=a(""),k=a(""),$=a(""),R=a(""),D=a(!1),z=a(""),A=a("disabled"),E=a(-1),W=a(),Y=a(),w=a(),C=a(new de);function P(){s.value.notificationTitle="",s.value.notificationDescription="",s.value.notificationDetails=""}async function O(o){o&&(B.value=!0);try{const n=(await T("ns.plug","status")).data;f.value=n.status,j.value=n.unit_id,$.value=n.server??"",k.value=n.unit_name,D.value=n.tls_verify,z.value=n.address??"",A.value=n.push_status??"disabled",E.value=n.push_last_sent??-1}catch(n){s.value.notificationTitle=t("error.cannot_fetch_controller_registration_status"),s.value.notificationDescription=t(M(n)),s.value.notificationDetails=n.toString()}finally{o&&(B.value=!1)}}async function Q(){await O(!0),f.value!=="unregistered"&&(N.value=setInterval(()=>{O()},1e4))}function G(){N.value&&clearInterval(N.value)}function J(){G(),Q()}function ne(o,n,y){for(let g of o)g.valid||(C.value.set(n,[g.errMessage]),w.value||(w.value=y));return o.every(g=>g.valid)}function ae(){C.value.clear();const o=[[[ee(k.value),xe(k.value)],"unit_name",W],[[ee(R.value)],"join_code",Y]];w.value=void 0;const n=o.map(([y,g,h])=>ne(y,g,h)).every(y=>y);return w.value&&Ve(w.value),n}async function le(){v.value=!0,V.value=!1;try{await T("ns.plug","register",{join_code:R.value,tls_verify:D.value,unit_name:k.value}),J()}catch(o){o instanceof ke?C.value=o.errorBag:(s.value.notificationTitle=t("error.cannot_connect_unit"),s.value.notificationDescription=t(M(o)),s.value.notificationDetails=o.toString())}finally{v.value=!1}}async function oe(){v.value=!0,P();try{await T("ns.plug","unregister"),S.value=!1,J()}catch(o){b.value.notificationDescription=t(M(o)),b.value.notificationDetails=o.toString()}finally{v.value=!1}}async function ie(){v.value=!0,P();try{await T("ns.plug","restart"),J()}catch(o){s.value.notificationTitle=t("error.cannot_restart_connection"),s.value.notificationDescription=t(M(o)),s.value.notificationDetails=o.toString()}finally{v.value=!1}}ve(()=>{Q()}),fe(()=>{G()});function se(){P(),ae()&&(V.value=!0)}return(o,n)=>{const y=K("RouterLink"),g=K("I18nT"),h=K("font-awesome-icon");return l(),_(x,null,[m("div",we,[i(e(_e),{tag:"h3",class:"mb-7"},{default:r(()=>[d(c(e(t)("standalone.controller.title")),1)]),_:1}),f.value!=="unregistered"?(l(),_("div",Ce,c(e(t)("standalone.controller.data_updated_every_seconds",{seconds:10})),1)):I("",!0)]),m("div",he,[s.value.notificationDescription?(l(),p(e(X),{key:0,kind:"error",title:s.value.notificationTitle,description:s.value.notificationDescription},H({_:2},[s.value.notificationDetails?{name:"details",fn:r(()=>[d(c(s.value.notificationDetails),1)]),key:"0"}:void 0]),1032,["title","description"])):I("",!0),i(De,{title:e(t)("standalone.controller.connect_unit"),description:e(t)("standalone.controller.connect_unit_description"),class:"max-w-3xl"},{default:r(()=>[B.value?(l(),p(e(me),{key:0,lines:10})):(l(),_("div",Ie,[i(e(U),{modelValue:k.value,"onUpdate:modelValue":n[0]||(n[0]=u=>k.value=u),disabled:f.value!=="unregistered",label:e(t)("standalone.controller.unit_name"),ref_key:"unitNameRef",ref:W,invalidMessage:e(t)(C.value.getFirstI18nKeyFor("unit_name"))},{tooltip:r(()=>[f.value==="unregistered"?(l(),p(e(L),{key:0},{content:r(()=>[d(c(e(t)("standalone.controller.unit_name_tooltip")),1)]),_:1})):I("",!0)]),_:1},8,["modelValue","disabled","label","invalidMessage"]),f.value==="unregistered"?(l(),p(e(pe),{key:0,modelValue:R.value,"onUpdate:modelValue":n[1]||(n[1]=u=>R.value=u),label:e(t)("standalone.controller.controller_join_code"),ref_key:"controllerJoinCodeRef",ref:Y,invalidMessage:e(t)(C.value.getFirstI18nKeyFor("join_code"))},{tooltip:r(()=>[i(e(L),null,{content:r(()=>[d(c(e(t)("standalone.controller.controller_join_code_tooltip")),1)]),_:1})]),_:1},8,["modelValue","label","invalidMessage"])):(l(),_(x,{key:1},[i(e(U),{modelValue:j.value,"onUpdate:modelValue":n[2]||(n[2]=u=>j.value=u),disabled:!0,label:e(t)("standalone.controller.unit_id")},null,8,["modelValue","label"]),i(e(U),{modelValue:$.value,"onUpdate:modelValue":n[3]||(n[3]=u=>$.value=u),disabled:!0,label:e(t)("standalone.controller.controller_url")},null,8,["modelValue","label"])],64)),f.value==="connected"?(l(),p(e(U),{key:2,modelValue:z.value,"onUpdate:modelValue":n[4]||(n[4]=u=>z.value=u),disabled:!0,label:e(t)("standalone.controller.vpn_ip_address")},null,8,["modelValue","label"])):I("",!0),f.value==="unregistered"?(l(),p(e(ge),{key:3,modelValue:D.value,"onUpdate:modelValue":n[5]||(n[5]=u=>D.value=u),"top-label":e(t)("standalone.controller.verify_tls_certificate"),label:D.value?e(t)("common.enabled"):e(t)("common.disabled")},null,8,["modelValue","top-label","label"])):(l(),_(x,{key:4},[m("div",Se,[m("label",Re,c(e(t)("common.status")),1),f.value==="pending"?(l(),p(e(F),{key:0,text:e(t)("standalone.controller.pending"),kind:"warning",size:"sm"},null,8,["text"])):(l(),p(e(F),{key:1,text:e(t)("standalone.controller.connected"),kind:"success",size:"sm"},null,8,["text"]))]),m("div",Ue,[m("div",Fe,[m("label",Te,c(e(t)("standalone.controller.sending_data_to_controller")),1),i(e(L),null,{content:r(()=>[i(g,{tag:"p",keypath:"standalone.controller.sending_data_to_controller_tooltip"},{subscription_link:r(()=>[i(e(ye),{"inverted-theme":""},{default:r(()=>[i(y,{to:`${e(be)(e(te))}/system/subscription`},{default:r(()=>[d(c(e(t)("standalone.controller.sending_data_to_controller_tooltip_link")),1)]),_:1},8,["to"])]),_:1})]),_:1})]),_:1})]),A.value=="enabled"?(l(),_(x,{key:0},[i(e(F),{text:e(t)("common.enabled"),kind:"success",size:"sm"},null,8,["text"]),m("p",Me,[E.value>-1?(l(),_(x,{key:0},[d(c(e(t)("standalone.controller.last_sent",{date:new Date(E.value*1e3).toLocaleString()})),1)],64)):(l(),_(x,{key:1},[d(c(e(t)("standalone.controller.no_last_sent")),1)],64))])],64)):(l(),p(e(F),{key:1,text:e(t)("common.disabled"),kind:"warning",size:"sm"},null,8,["text"]))])],64)),f.value==="unregistered"?(l(),_("div",Be,[i(e(q),{kind:"primary",onClick:se,disabled:v.value},{prefix:r(()=>[i(h,{icon:["fas","link"],class:"h-4 w-4","aria-hidden":"true"}),d(" "+c(e(t)("standalone.controller.connect_unit")),1)]),_:1},8,["disabled"])])):(l(),_("div",Ne,[i(e(q),{kind:"tertiary",onClick:n[6]||(n[6]=u=>S.value=!0),disabled:v.value},{prefix:r(()=>[i(h,{icon:["fas","link-slash"],class:"h-4 w-4","aria-hidden":"true"}),d(" "+c(e(t)("standalone.controller.disconnect_unit")),1)]),_:1},8,["disabled"]),i(e(q),{kind:"secondary",onClick:ie,disabled:v.value},{prefix:r(()=>[i(h,{icon:["fas","arrows-rotate"],class:"h-4 w-4","aria-hidden":"true"}),d(" "+c(e(t)("standalone.controller.restart_connection")),1)]),_:1},8,["disabled"])]))]))]),_:1},8,["title","description"])]),i(e(Z),{"primary-button-disabled":v.value,"primary-button-loading":v.value,"primary-label":e(t)("standalone.controller.disconnect"),title:e(t)("standalone.controller.disconnect_unit"),visible:S.value,kind:"warning","primary-button-kind":"danger","close-aria-label":e(t)("common.close"),onClose:n[7]||(n[7]=u=>S.value=!1),onPrimaryClick:oe},{default:r(()=>[d(c(e(t)("standalone.controller.disconnect_unit_message"))+" ",1),b.value.notificationDescription?(l(),p(e(X),{key:0,title:e(t)("error.cannot_connect_unit"),description:b.value.notificationDescription,kind:"error"},H({_:2},[b.value.notificationDetails?{name:"details",fn:r(()=>[d(c(b.value.notificationDetails),1)]),key:"0"}:void 0]),1032,["title","description"])):I("",!0)]),_:1},8,["primary-button-disabled","primary-button-loading","primary-label","title","visible","close-aria-label"]),i(e(Z),{visible:V.value,kind:"info",title:e(t)("standalone.controller.connect_unit"),"primary-label":e(t)("standalone.controller.confirm_and_connect"),"close-aria-label":e(t)("common.close"),onPrimaryClick:le,onSecondaryClick:n[8]||(n[8]=u=>V.value=!1),"secondary-label":e(t)("common.cancel"),onClose:n[9]||(n[9]=u=>V.value=!1)},{default:r(()=>[m("strong",null,c(e(t)("standalone.controller.disclaimer"))+": ",1),m("p",null,c(e(t)("standalone.controller.connect_unit_message")),1)]),_:1},8,["visible","title","primary-label","close-aria-label","secondary-label"])],64)}}});export{Ee as default};
